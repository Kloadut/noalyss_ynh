set -e

# Retrieve arguments
domain=$1
path=$2

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a noalyss
if [[ ! $? -eq 0 ]]; then
    exit 1
fi

path=${path%/}

sudo apt-get install postgresql php5 php5-pgsql php5-gd php-gettext p7zip-full libgd2-xpm-dev

final_path=/var/www/noalyss
sudo mkdir -p $final_path
sudo cp -a ../sources/html/ $final_path
sudo cp -a ../sources/include/ $final_path

sudo chown -R www-data: $final_path

sudo yunohost app setting noalyss version -v "6.9.0.0"

# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app ssowatconf

if [[ "$path" == "" ]]; then
  sed -i "s@LOCATIONTOCHANGE@/@g" ../conf/nginx.conf
else
  sed -i "s@LOCATIONTOCHANGE@$path@g" ../conf/nginx.conf
fi

sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/noalyss.conf

sed -i "s@NAMETOCHANGE@noalyss@g" ../conf/php-fpm.conf

finalphpconf=/etc/php5/fpm/pool.d/noalyss.conf

sudo cp ../conf/php-fpm.conf $finalphpconf
sudo chown root: $finalphpconf
sudo chmod 644 $finalphpconf
